from opentrons import protocol_api,types
import serial
import time
import sys


metadata = {'apiLevel': '2.3'}

def run(protocol: protocol_api.ProtocolContext):

    if protocol.is_simulating() == False:
        sys.path.insert(0, "/data")
        import DispenseUnit_1161
        import pyTMCL
        serial_port = serial.Serial("/dev/ttyACM0", 9600)
        bus = pyTMCL.connect(serial_port)
        pump_1 = DispenseUnit_1161.DispenseUnit_1161("fakeparent", bus, 1, 0)

    # Pipets
    p300 = protocol.load_instrument('p300_multi_gen2', 'left')
    p20 = protocol.load_instrument('p20_multi_gen2', 'right')

    # Tips
    tiprack_300 = protocol.load_labware('opentrons_96_tiprack_300ul', 9)
    tiprack_20_plate1 = protocol.load_labware('opentrons_96_tiprack_20ul', 10)
    tiprack_20_plate2 = protocol.load_labware('opentrons_96_tiprack_20ul', 11)

    # Plates
    mother_plate1 = protocol.load_labware('greiner_96_petit_puit', 7)
    mother_plate2 = protocol.load_labware('greiner_96_petit_puit', 8)
    plate_to_normalize1 = protocol.load_labware('axygenpcr_96_wellplate_200ul_onspacer', 4)
    plate_to_normalize2 = protocol.load_labware('axygenpcr_96_wellplate_200ul_onspacer', 5)
    op2_plate1 = protocol.load_labware('axygenpcr_96_wellplate_200ul', 1)
    op2_plate2 = protocol.load_labware('axygenpcr_96_wellplate_200ul', 2)

    # Reservoirs
    LadderReservoir = protocol.load_labware('ladder_4_reservoir_63000ul', 6)

    del protocol.deck['4']
    plate_to_normalize1 = protocol.load_labware('greiner_96well_full_area_350ul_onspacer', 4)


    p20.pick_up_tip(tiprack_20_plate1.wells()[0])
    p20.aspirate(4.0, mother_plate1.wells()[0].bottom(1.3), 1)
    p20.dispense(4.0, plate_to_normalize1.wells()[0].bottom(0), 1)
    p300.move_to(plate_to_normalize1.wells()[0].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(13.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize1.wells()[1].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(4.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize1.wells()[3].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(10.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize1.wells()[4].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(14.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize1.wells()[6].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(5.0)
        pump_1.wait_for_canmove()
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[8])
    p20.aspirate(4.0, mother_plate1.wells()[8].bottom(1.3), 1)
    p20.dispense(4.0, plate_to_normalize1.wells()[8].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[16])
    p20.aspirate(4.0, mother_plate1.wells()[16].bottom(1.3), 1)
    p20.dispense(4.0, plate_to_normalize1.wells()[16].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[24])
    p20.aspirate(4.0, mother_plate1.wells()[24].bottom(1.3), 1)
    p20.dispense(4.0, plate_to_normalize1.wells()[24].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[40])
    p20.aspirate(10.0, mother_plate1.wells()[40].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[40].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[48])
    p20.aspirate(10.0, mother_plate1.wells()[48].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[48].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[56])
    p20.aspirate(15.0, mother_plate1.wells()[56].bottom(1.3), 1)
    p20.dispense(15.0, plate_to_normalize1.wells()[56].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[64])
    p20.aspirate(10.0, mother_plate1.wells()[64].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[64].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[72])
    p20.aspirate(10.0, mother_plate1.wells()[72].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[72].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[80])
    p20.aspirate(10.0, mother_plate1.wells()[80].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[80].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate1.wells()[88])
    p20.aspirate(10.0, mother_plate1.wells()[88].bottom(1.3), 1)
    p20.dispense(10.0, plate_to_normalize1.wells()[88].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[0])
    p20.aspirate(2.0, mother_plate2.wells()[0].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[0].bottom(0), 1)
    p300.move_to(plate_to_normalize2.wells()[0].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(17.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[1].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(16.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[2].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(14.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[3].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(11.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[4].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(12.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[5].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(15.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[6].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(16.0)
        pump_1.wait_for_canmove()
    p300.move_to(plate_to_normalize2.wells()[7].center().move(types.Point(x=-2.5,y=84,z=8)))
    if protocol.is_simulating()==False:
        pump_1.wait_for_idle()
        pump_1.dispense(18.0)
        pump_1.wait_for_canmove()
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[8])
    p20.aspirate(2.0, mother_plate2.wells()[8].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[8].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[16])
    p20.aspirate(2.0, mother_plate2.wells()[16].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[16].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[24])
    p20.aspirate(2.0, mother_plate2.wells()[24].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[24].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[32])
    p20.aspirate(2.0, mother_plate2.wells()[32].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[32].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[40])
    p20.aspirate(2.0, mother_plate2.wells()[40].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[40].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[48])
    p20.aspirate(2.0, mother_plate2.wells()[48].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[48].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[56])
    p20.aspirate(2.0, mother_plate2.wells()[56].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[56].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[64])
    p20.aspirate(2.0, mother_plate2.wells()[64].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[64].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[72])
    p20.aspirate(2.0, mother_plate2.wells()[72].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[72].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[80])
    p20.aspirate(2.0, mother_plate2.wells()[80].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[80].bottom(0), 1)
    p20.return_tip()
    p20.pick_up_tip(tiprack_20_plate2.wells()[88])
    p20.aspirate(2.0, mother_plate2.wells()[88].bottom(1.3), 1)
    p20.dispense(2.0, plate_to_normalize2.wells()[88].bottom(0), 1)
    p20.return_tip()
